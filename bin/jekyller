#!/usr/bin/env ruby
require "date"
require "erb"
require "optparse"

command = ARGV.shift.to_sym

output_type = :post
create_force = false
post_date = Date.today
title = nil
tags = []
keywords = nil
description = nil

op = OptionParser.new

op.on("-f") { create_force = true }
op.on("-d NUM", Integer) { |i| post_date += i }
op.on("--title TITLE", String) { |s| title = s }
op.on("--tags TAGS", String) { |s| tags = s.split(/,/) }
op.on("--keywords KEYWORDS", String) { |s| keywords = s.split(/,/) }
op.on("--description DESCRIPTION", String) { |s| description = s }

op.parse!(ARGV)

name = ARGV[0]

title ||= name
keywords ||= tags

post_time = "#{post_date.strftime("%Y-%m-%d")} #{Time.now.strftime("%H:%M:%S")}J"

template_file = "_template/default.md.erb"

case command
when :draft
  Dir.mkdir("_drafts") unless Dir.exists?("_drafts")
  output_file = "_drafts/#{name}.md.erb"
  post_time = "<%=post_time%>"
when :post
  output_file = "_posts/#{post_date.strftime("%Y-%m-%d")}-#{name}.md"
when :publish
  template_file = "_drafts/#{name}.md.erb"
  output_file = "_posts/#{post_date.strftime("%Y-%m-%d")}-#{name}.md"
end

unless File.exists?(template_file)
  STDERR.puts "#{template_file} already exists"
  exit 1
end

if !create_force && File.exists?(output_file)
  STDERR.puts "#{output_file} already exists"
  exit 1
end

erb = ERB.new(File.read(template_file))

File.write(output_file, erb.result(binding))

STDERR.puts "created #{output_file}"
